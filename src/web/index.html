<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrapeTree WebAssembly - Phylogenetic Tree Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .controls-panel {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .control-group {
            margin-bottom: 1.5rem;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #555;
        }
        
        .control-group select,
        .control-group input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .visualization-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        
        #tree-canvas {
            width: 100%;
            height: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-info {
            font-size: 0.9rem;
            color: #666;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
            animation: progress 1.5s infinite;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .info-panel {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 4px;
            margin-top: 2rem;
        }
        
        .info-panel h3 {
            margin-bottom: 1rem;
            color: #667eea;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .info-item {
            padding: 1rem;
            background: white;
            border-radius: 4px;
        }
        
        .info-item strong {
            display: block;
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .info-item span {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            max-width: 250px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9rem;
            z-index: 100;
        }

        .legend-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
            flex-shrink: 0;
        }

        .legend-label {
            flex: 1;
            color: #555;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üçá GrapeTree WebAssembly</h1>
        <p>Interactive phylogenetic tree visualization - Powered by WebAssembly</p>
    </div>
    
    <div class="container">
        <div class="controls-panel">
            <h2 style="margin-bottom: 1.5rem;">Tree Configuration</h2>
            
            <div class="error-message" id="error-message"></div>
            
            <div class="progress-bar" id="progress-bar">
                <div class="progress-fill"></div>
            </div>
            
            <div class="control-group">
                <label for="file-input">Upload Data File</label>
                <input type="file" id="file-input" accept=".txt,.csv,.tsv,.fasta,.fa,.json">
                <small style="color: #999; margin-top: 0.5rem; display: block;">
                    Supported: MLST/cgMLST profiles (.txt, .csv), aligned FASTA (.fasta), or JSON
                </small>
            </div>

            <div class="control-group">
                <label for="metadata-input">Upload Metadata (Optional)</label>
                <input type="file" id="metadata-input" accept=".txt,.csv,.tsv">
                <small style="color: #999; margin-top: 0.5rem; display: block;">
                    Supported: Tab or comma delimited files with ID column
                </small>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="control-group">
                    <label for="method-select">Tree Method</label>
                    <select id="method-select">
                        <option value="MSTreeV2" selected>MSTreeV2 (Recommended)</option>
                        <option value="MSTree">MSTree (Classical)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="matrix-select">Matrix Type</label>
                    <select id="matrix-select">
                        <option value="asymmetric" selected>Asymmetric</option>
                        <option value="symmetric">Symmetric</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="missing-select">Missing Data</label>
                    <select id="missing-select">
                        <option value="0" selected>Ignore</option>
                        <option value="1">Remove Column</option>
                        <option value="2">Treat as Allele</option>
                        <option value="3">Absolute Difference</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="heuristic-select">Tiebreak Heuristic</label>
                    <select id="heuristic-select">
                        <option value="harmonic" selected>Harmonic Mean</option>
                        <option value="eBurst">eBurst</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="color-select">Color By</label>
                    <select id="color-select" disabled>
                        <option value="">None (Default)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="edge-scale-select">Edge Distance Scale</label>
                    <select id="edge-scale-select">
                        <option value="linear" selected>Linear</option>
                        <option value="log">Logarithmic</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group" style="margin-top: 1.5rem;">
                <button class="btn-primary" id="compute-btn">Compute Tree</button>
                <button class="btn-secondary" id="download-newick-btn">Download Newick</button>
                <button class="btn-secondary" id="download-json-btn">Download GrapeTree JSON</button>
                <button class="btn-secondary" id="download-svg-btn">Download SVG</button>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-info" id="status-info">
                Ready to load data
            </div>
        </div>
        
        <div class="visualization-container">
            <div id="tree-canvas">
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">
                    <div style="text-align: center;">
                        <h3>No tree computed yet</h3>
                        <p style="margin-top: 1rem;">Upload a data file and click "Compute Tree" to get started</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-panel" id="tree-info" style="display: none;">
            <h3>Tree Statistics</h3>
            <div class="info-grid">
                <div class="info-item">
                    <strong>Number of Nodes</strong>
                    <span id="stat-nodes">-</span>
                </div>
                <div class="info-item">
                    <strong>Number of Edges</strong>
                    <span id="stat-edges">-</span>
                </div>
                <div class="info-item">
                    <strong>Computation Time</strong>
                    <span id="stat-time">-</span>
                </div>
                <div class="info-item">
                    <strong>Tree Method</strong>
                    <span id="stat-method" style="font-size: 1.2rem;">-</span>
                </div>
            </div>
        </div>
    </div>
    
    <script src="grapetree.js"></script>
    <script type="module">
        import GrapeTreeWASM from './wasm_loader.js';
        import FileHandler from './file_handler.js';
        
        // Initialize application
        let grapetree = null;
        let fileHandler = new FileHandler();
        let currentData = null;
        let currentMetadata = null;
        let currentTree = null;
        
        // DOM elements
        const fileInput = document.getElementById('file-input');
        const metadataInput = document.getElementById('metadata-input');
        const computeBtn = document.getElementById('compute-btn');
        const downloadNewickBtn = document.getElementById('download-newick-btn');
        const downloadJsonBtn = document.getElementById('download-json-btn');
        const colorSelect = document.getElementById('color-select');
        const edgeScaleSelect = document.getElementById('edge-scale-select');
        const statusInfo = document.getElementById('status-info');
        const errorMessage = document.getElementById('error-message');
        const progressBar = document.getElementById('progress-bar');
        const treeInfo = document.getElementById('tree-info');
        
        // Initialize WASM
        async function init() {
            try {
                statusInfo.textContent = 'Initializing WebAssembly module...';
                grapetree = new GrapeTreeWASM();
                await grapetree.init();
                statusInfo.textContent = 'Ready to load data';
                console.log('GrapeTree WASM initialized');
            } catch (error) {
                showError('Failed to initialize: ' + error.message);
            }
        }
        
        // File upload handler
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                statusInfo.textContent = `Loading ${file.name}...`;
                currentData = await fileHandler.parse(file);
                statusInfo.textContent = 
                    `Loaded ${currentData.strains.length} strains with ` +
                    `${currentData.profiles[0].length} loci`;
                computeBtn.disabled = false;
            } catch (error) {
                showError('Failed to parse file: ' + error.message);
            }
        });

        // Metadata upload handler
        metadataInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                statusInfo.textContent = `Loading metadata ${file.name}...`;
                const content = await fileHandler._readFile(file);
                const result = fileHandler.parseMetadata(content);
                currentMetadata = result.metadata;

                // Populate color select
                colorSelect.innerHTML = '<option value="">None (Default)</option>';
                result.fields.forEach(field => {
                    const option = document.createElement('option');
                    option.value = field;
                    option.textContent = field;
                    colorSelect.appendChild(option);
                });
                colorSelect.disabled = false;

                statusInfo.textContent = `Loaded metadata for ${Object.keys(currentMetadata).length} strains`;

                // Re-render if tree exists
                if (currentTree) {
                    displayTree(currentTree);
                }

            } catch (error) {
                showError('Failed to parse metadata: ' + error.message);
            }
        });

        // Color selection handler
        colorSelect.addEventListener('change', () => {
            if (currentTree) {
                displayTree(currentTree);
            }
        });

        // Edge scale selection handler
        edgeScaleSelect.addEventListener('change', () => {
            if (currentTree) {
                displayTree(currentTree);
            }
        });
        
        // Compute tree
        computeBtn.addEventListener('click', async () => {
            if (!currentData) {
                showError('Please load a data file first');
                return;
            }
            
            try {
                hideError();
                showProgress();
                
                const method = document.getElementById('method-select').value;
                const matrix = document.getElementById('matrix-select').value;
                const missing = parseInt(document.getElementById('missing-select').value);
                const heuristic = document.getElementById('heuristic-select').value;
                
                statusInfo.textContent = `Computing ${method} tree...`;
                const startTime = performance.now();
                
                currentTree = grapetree.computeTree({
                    data: currentData,
                    method,
                    matrix,
                    missing,
                    heuristic
                });
                
                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                hideProgress();
                statusInfo.textContent = 
                    `Tree computed in ${duration}s - ${currentTree.nNodes} nodes, ` +
                    `${currentTree.nEdges} edges`;
                
                // Update statistics
                document.getElementById('stat-nodes').textContent = currentTree.nNodes;
                document.getElementById('stat-edges').textContent = currentTree.nEdges;
                document.getElementById('stat-time').textContent = duration + 's';
                document.getElementById('stat-method').textContent = method;
                treeInfo.style.display = 'block';
                
                // Enable download buttons
                downloadNewickBtn.disabled = false;
                downloadJsonBtn.disabled = false;
                
                // Display tree (placeholder - would integrate D3.js visualization)
                displayTree(currentTree);
                
            } catch (error) {
                hideProgress();
                showError('Tree computation failed: ' + error.message);
            }
        });
        
        // Download Newick
        downloadNewickBtn.addEventListener('click', () => {
            if (!currentTree) return;
            
            const newick = grapetree.exportNewick(currentTree);
            downloadFile(newick, 'tree.nwk', 'text/plain');
        });

        // Download GrapeTree JSON
        downloadJsonBtn.addEventListener('click', () => {
            if (!currentTree || !currentData) return;

            const json = {
                metadata: {},
                tree: currentTree.newick,
                initialTree: currentTree.newick
            };

            // Populate metadata
            // Format: ID: [val1, val2, ...]
            // But GrapeTree JSON usually has metadata as:
            // "metadata": { "ID": { "col": "val", ... } } ??
            // No, GrapeTree standard JSON usually stores metadata in a specific way.
            // But usually for GrapeTree standalone, the "metadata" key in JSON file contains lines from the profile + metadata.

            // For simplicity, we can create a JSON structure compatible with what GrapeTree expects if possible,
            // or just a JSON dump of what we have.
            // The user requested "GrapeTree .json file".
            // The format usually includes a "metadata" object where keys are strain names and values are objects/arrays.

            // Let's assume a simple format:
            // metadata: { "strain1": { "col1": "val1" }, ... }

            // We should merge profile data and external metadata.

            currentData.strains.forEach((strain, i) => {
                json.metadata[strain] = {};
                // Add profile data? Usually not necessary if tree is there, but useful.
                // But GrapeTree often uses metadata for coloring.

                if (currentMetadata && currentMetadata[strain]) {
                    Object.assign(json.metadata[strain], currentMetadata[strain]);
                }
            });

            downloadFile(JSON.stringify(json, null, 2), 'grapetree.json', 'application/json');
        });
        
        // Helper functions
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        function showProgress() {
            progressBar.style.display = 'block';
        }
        
        function hideProgress() {
            progressBar.style.display = 'none';
        }
        
        function displayTree(tree) {
            const canvas = document.getElementById('tree-canvas');
            canvas.innerHTML = '';

            const width = canvas.clientWidth;
            const height = canvas.clientHeight;

            // Prepare graph data
            const nodes = currentData.strains.map((name, i) => ({ id: i, name: name }));
            const links = tree.edges.map(e => ({ source: e.from, target: e.to, distance: e.distance }));

            // Get selected options
            const selectedColumn = colorSelect.value;
            const edgeScale = edgeScaleSelect.value;

            // Build color scale with all unique values
            let colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            let uniqueValues = new Set();
            let colorMapping = {};

            if (selectedColumn && currentMetadata) {
                // Collect all unique values for the selected column
                Object.keys(currentMetadata).forEach(strain => {
                    if (currentMetadata[strain] && currentMetadata[strain][selectedColumn]) {
                        const value = currentMetadata[strain][selectedColumn];
                        uniqueValues.add(value);
                    }
                });

                // Create stable color mapping
                const sortedValues = Array.from(uniqueValues).sort();
                sortedValues.forEach((value, idx) => {
                    colorMapping[value] = colorScale(idx);
                });
            }

            // Create SVG
            const svg = d3.select('#tree-canvas')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height])
                .style('max-width', '100%')
                .style('height', 'auto');

            // Add zoom
            const g = svg.append('g');
            svg.call(d3.zoom()
                .extent([[0, 0], [width, height]])
                .scaleExtent([0.1, 8])
                .on('zoom', ({transform}) => g.attr('transform', transform)));

            // Calculate edge distances based on scale
            const distanceFunction = edgeScale === 'log'
                ? (d) => Math.max(20, Math.log(d.distance + 1) * 30)
                : (d) => Math.max(20, d.distance * 10);

            // Simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(distanceFunction))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));

            // Draw links
            const linkGroup = g.append('g').selectAll('g').data(links).join('g');

            const link = linkGroup.append('line')
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6)
                .attr('stroke-width', 2);

            // Edge distances labels
            const linkLabel = linkGroup.append('text')
                .attr('font-size', '10px')
                .attr('fill', '#666')
                .attr('text-anchor', 'middle')
                .text(d => d.distance > 0 ? d.distance.toFixed(1) : "");

            // Draw nodes with proper coloring
            const node = g.append('g')
                .attr('stroke', '#fff')
                .attr('stroke-width', 1.5)
                .selectAll('circle')
                .data(nodes)
                .join('circle')
                .attr('r', 8)
                .attr('fill', d => {
                    if (selectedColumn && currentMetadata && currentMetadata[d.name]) {
                        const value = currentMetadata[d.name][selectedColumn];
                        if (value && colorMapping[value]) {
                            return colorMapping[value];
                        }
                    }
                    return '#667eea';
                })
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add labels
            const label = g.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .attr('dx', 12)
                .attr('dy', '.35em')
                .text(d => d.name)
                .style('font-size', '12px')
                .style('fill', '#333')
                .style('pointer-events', 'none');

            node.append('title')
                .text(d => {
                    let text = d.name;
                    if (selectedColumn && currentMetadata && currentMetadata[d.name]) {
                        const value = currentMetadata[d.name][selectedColumn];
                        if (value) {
                            text += `\n${selectedColumn}: ${value}`;
                        }
                    }
                    return text;
                });

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                linkLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            // Add legend if metadata coloring is active
            if (selectedColumn && uniqueValues.size > 0) {
                const legend = document.createElement('div');
                legend.className = 'legend';

                let legendHTML = `<div class="legend-title">${selectedColumn}</div>`;

                const sortedValues = Array.from(uniqueValues).sort();
                sortedValues.forEach(value => {
                    const color = colorMapping[value];
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${color}"></div>
                            <div class="legend-label">${value}</div>
                        </div>
                    `;
                });

                legend.innerHTML = legendHTML;
                canvas.appendChild(legend);
            }

            // Add success message overlay
            const overlay = document.createElement('div');
            overlay.style.position = 'absolute';
            overlay.style.top = '10px';
            overlay.style.left = '10px';
            overlay.style.background = 'rgba(255, 255, 255, 0.9)';
            overlay.style.padding = '10px';
            overlay.style.borderRadius = '4px';
            overlay.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            overlay.innerHTML = `
                <h4 style="color: #667eea; margin: 0;">‚úì Tree Computed</h4>
                <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">
                    ${tree.nNodes} nodes, ${tree.nEdges} edges
                </div>
            `;
            canvas.style.position = 'relative';
            canvas.appendChild(overlay);
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>
